<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name = "viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ page_title }}</title>

        <!-- CSS Dependencies -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        
        <!-- Custom CSS-->
         <style>
            /* Dashboard Custom Styles */
            :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            }

            body {
                background-color: var(--light-color);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            .navbar {
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .navar-brand {
                font-weight: bold;
                font-size: 1.5rem;
            }

            .card {
                border: none;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            }

            .card-header {
                background: linear-gradient(135deg, #fff, #f8f9fa);
                border-bottom: 1px solid #e9ecef;
                border-radius: 15px 15px 0 0 !important;
                font-weight: 600;
            }

            .metric-card {
                text-align: center;
                padding: 20px;
            }

            .metric-value {
                font-size: 2.5rem;
                font-weight: bold;
                margin: 10px 0;
            }

            .metric-label {
                color: #6c757d;
                font-size: 0.9rem;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .positive {
                color: var(--success-color);
            }

            .negative {
                color: var(--danger-color);
            }

            .neutral {
                color: var(--info-color);
            }

            .chart-container {
                position: relative;
                height: 400px;
                margin: 20px 0;
            }

            .loading {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 200px;
                color: #6c757d;
            }

            .symbol-selector {
                margin-bottom: 20px;
            }

            .symbol-selector select {
                border-radius: 8px;
                border: 2px solid #e9ecef;
                transition: border-color 0.3s ease;
            }

            .symbol-selector select:focus {
                border-color: var(--secondary-color);
                box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            }

            .portfolio-summary {
                background: linear-gradient(135deg, var(--success-color), #2ecc71);
                color: white;
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 30px;
            }

            .top-performers {
                background: linear-gradient(135deg, var(--info-color), #3498db);
                color: white;
            }

            .recent-activity {
                background: linear-gradient(135deg, var(--warning-color), #367e22);
                color: white;
            }

            .stock-item {
                padding: 10px;
                margin: 5px 0;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .stock-symbol {
                font-weight: bold;
                font-size: 1.1rem;
            }

            .stock-change {
                font-weight: bold;
            }

            .refresh-btn {
                position: fixed;
                bottom: 30px;
                right: 30px;
                border-radius: 50px;
                padding: 15px 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
            }

            .status-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
            }

            .status-connected {
                background-color: var(--success-color);
            }

            .status-loading {
                background-color: var(--warning-color);
                animation: pulse 2s infinite;
            }

            .status-error {
                background-color: var(--danger-color);
            }

            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                1000% { opacity: 1; }
            }

            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .metric-value {
                    font-size: 2rem;
                }

                .chart-container {
                    height: 300px;
                }

                .refresh-btn {
                    bottom: 20px;
                    right: 20px;
                    padding: 12px 16px;
                }
            }
         </style>
    </head>

    <body>
        <!-- Navigation Bar -->
         <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-chart-line me-2"></i>
                    Stock Market Dashboard
                </a>

                <div class="navbar-nav ms-auto">
                    <div class="nav-item d-flex align-items-center">
                        <span class="status-indicator status-connected" id="connectionStatus"></span>
                        <span class="text-light" id="connectionText">Connected</span>
                    </div>
                </div>
            </div>
         </nav>

         <!-- Main Content -->
        <div class="container-fluid mt-4">
            <!-- Portfolio Summary Row -->
            <div class="row mb-4">

                <div class="col-md-4">
                    <div class="card portfolio-summary">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-briefcase me-2"></i>
                                Portfolio Overview
                            </h5>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="metric-value" id="totalSymbols">{{ portfolio_summary.summary.total_symbols }}</div>
                                    <div class="metric-label">Symbols Tracked</div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-value {{ 'positive' if portfolio_summary.summary.avg_daily_return > 0 else 'negative' if portfolio_summary.summary.avg_daily_return < 0 else 'neutral' }}"
                                        id="avgReturn">{{ "%.2f"|format(portfolio_summary.summary.avg_daily_return * 100) }}%</div>
                                    <div class="metric-label">Average Daily Return</div>
                                </div>
                            </div>
                            <div class="row text-center mt-3">
                                <div class="col-6">
                                    <div class="metric-value" id="positiveStocks">{{ portfolio_summary.summary.positive_stocks }}</div>
                                    <div class="metric-label">Positive Today</div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-value" id="positiveRatio">{{ portfolio_summary.summary.positive_ratio }}%</div>
                                    <div class="metric-label">Success Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card top-performers">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-trophy me-2"></i>
                                Top Weekly Performers
                            </h5>
                            <div id="topPerformers">
                                {% for stock in portfolio_summary.top_performers[:3] %}
                                <div class="stock-item">
                                    <div>
                                        <div class="stock-symbol">{{ stock.symbol }}</div>
                                        <small>{{ stock.company_name[:20] }}...</small>
                                    </div>
                                    <div class="stock-change">{{ "+%.2f"|format(stock.weekly_return) }}%</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card recent-activity">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-activity me-2"></i>
                                High Volume Activity
                            </h5>
                            <div id="recentActivity">
                                {% for stock in portfolio_summary.recent_activity[:3] %}
                                <div class="stock-item">
                                    <div>
                                        <div class="stock-symbol">{{ stock.symbol }}</div>
                                        <small>${{ "{:,}".format(stock.volume) }}</small>
                                    </div>
                                    <div>{{ "{:,}".format(stock.volume) }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
             <div class="row">
                <!-- Stock Price Chart -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Stock Price Analysis
                            </h5>
                            <div class="symbol-selector">
                                <select class="form-select" id="stockSymbolSelect">
                                    <option value="">Select a stock...</option>
                                    {% for symbol in symbols %}
                                    <option value="{{ symbol }}">{{ symbol }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div class="loading" id="priceChartLoading" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Loading chart data...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Indicators -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Technical Indicators
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="technicalIndicators">
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Select a stock to view indicators
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Metrics -->
                     <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Market Metrics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="metric-card" id="marketMetrics">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <div class="metric-value text-muted" id="selectedSymbol">-</div>
                                        <div class="metric-label">Selected Symbol</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-value text-muted" id="currentPrice">$-</div>
                                        <div class="metric-label">Current Price</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-value text-muted" id="dailyChange">-%</div>
                                        <div class="metric-label">Daily Change</div>
                                    </div>
                                    <div class="col-6 mt-3">
                                        <div class="metric-value text-muted" id="volatility">-%</div>
                                        <div class="metric-label">30 Day Volatility</div>
                                    </div>
                                    <div class="col-6 mt-3">
                                        <div class="metric-value text-muted" id="trend">-</div>
                                        <div class="metric-label">Trend</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                     </div>
                  </div>
             </div>

             <!-- Moving Averages Chart -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-wave-square me-2"></i>
                                Moving Averages & Indicators
                            </h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" id="show30Days">30 Days</button>
                                <button type="button" class="btn btn-outline-primary active" id="show90Days">90 Days</button>
                                <button type="button" class="btn btn-outline-primary" id="show180Days">180 Days</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 500px;">
                                <canvas id="indicatorsChart"></canvas>
                            </div>
                            <div class="loading" id="indicatorsChartLoading" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Loading indicators data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refresh Button -->
        <button class="btn btn-primary refresh-btn" id="refreshBtn" title="Refresh Data">
            <i class="fas fa-sync-alt"></i>
            Refresh Data
        </button>

        <!-- Toast Container for Notifications -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- JavaScript Dependencies -->
         <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
         <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

        <!-- Custom JavaScript -->
         <script>
            /**
             * Stock Market Dashboard JavaScript
             * =================================
             * 
             * This script handles all of the frontend functionality for the dashboard:
             * - Chart rendering and updates
             * - API data fetching and caching
             * - Real-time data refresh
             * - User interactions and animations
             * - Error handling and notifications
             */

             class StockDashboard {
                constructor() {
                    this.currentSymbol = null;
                    this.currentDays = 90;
                    this.charts = {};
                    this.refreshInterval = null;
                    this.isLoading = false;

                    this.init();
                }

                init() {
                    this.initializeEventHandlers();
                    this.initializeCharts();
                    this.startAutoRefresh();
                    console.log('Stock Dashboard initialized');
                }

                initializeEventHandlers() {
                    // Symbol selection
                    document.getElementById('stockSymbolSelect').addEventListener('change', (e) => {
                        this.selectSymbol(e.target.value);
                    });

                    // Time period buttons
                    document.getElementById('show30Days').addEventListener('click', () => this.changePeriod(30));
                    document.getElementById('show90Days').addEventListener('click', () => this.changePeriod(90));
                    document.getElementById('show180Days').addEventListener('click', () => this.changePeriod(180));

                    // Refresh button
                    document.getElementById('refreshBtn').addEventListener('click', () => {
                        this.refreshAllData();
                    });

                    // Auto-select first symbol if available
                    const symbolSelect = document.getElementById('stockSymbolSelect');
                    if (symbolSelect.options.length > 1) {
                        symbolSelect.selectedIndex = 1;
                        this.selectSymbol(symbolSelect.value);
                    }
                }

                initializeCharts() {
                    // Price chart
                    const priceCtx = document.getElementById('priceChart').getContext('2d');
                    this.charts.price = new Chart(priceCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Price',
                                data: [],
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52,152,219, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    // Indicators Chart
                    const indicatorsCtx = document.getElementById('indicatorsChart').getContext('2d');
                    this.charts.indicators = new Chart(indicatorsCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Price',
                                    data: [],
                                    borderColor: '#2c3e50',
                                    backgroundColor: 'rgba(44, 62, 80, 0.1)',
                                    borderWidth: 2,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'SMA 20',
                                    data: [],
                                    borderColor: '#f39c12',
                                    backgroundColor: 'transparent',
                                    borderWidth: 2,
                                    yAxisID: 'y',
                                    pointRadius: 0
                                },
                                {
                                    label: 'SMA 50',
                                    data: [],
                                    borderColor: '#f39c12',
                                    backgroundColor: 'transparent',
                                    borderWidth: 2,
                                    yAxisID: 'y',
                                    pointRadius: 0
                                },
                                {
                                    label: 'Volume',
                                    data: [],
                                    type: 'bar',
                                    borderColor: '#95a5a6',
                                    backgroundColor: 'rgba(149, 165, 166, 0.3)',
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return ''
                                            + value.toFixed(2);
                                        }
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        }
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                }

                async selectSymbol(symbol) {
                    if (!symbol || symbol === this.currentSymbol) return;

                    this.currentSymbol = symbol;
                    this.updateConnectionStatus('loading', 'Loading data...');

                    try {
                        await Promise.all([
                            this.loadPriceData(symbol),
                            this.loadIndicatorsData(symbol)
                        ]);

                        this.updateConnectionStatus('connected', 'Connected');
                        this.showToast('success', `Loaded data for ${symbol}`);

                    } catch (error) {
                        console.error('Error loading symbol data:', error);
                        this.updateConnectionStatus('error', 'Error loading data');
                        this.showToast('error', `Failed to load data for ${symbol}`);
                    }
                }

                async loadPriceData(symbol) {
                    const response = await fetch(`/api/stock/${symbol}?days=${this.currentDays}`);
                    if (!response.ok) throw new Error('Failed to fetch price data');

                    const data = await response.json();
                    this.updatePriceChart(data);
                    this.updateMarketMetrics(data);
                }

                async loadIndicatorsData(symbol) {
                    const response = await fetch(`/api/indicators/${symbol}?days=${this.currentDays}`);
                    if (!response.ok) throw new Error('Failed to fetch indicators data');

                    const data = await response.json();
                    this.updateIndicatorsChart(data);
                    this.updateTechnicalIndicators(data);
                }

                updatePriceChart(data) {
                    const chart = this.charts.price;
                    const prices = data.data || [];

                    chart.data.labels = prices.map(item => moment(item.date).format('MMM DD'));
                    chart.data.datasets[0].data = prices.map(item => item.close);
                    chart.data.datasets[0].label = `${data.symbol} Price`;

                    chart.update('none');
                }

                updateIndicatorsChart(data) {
                    const chart = this.charts.indicators;
                    const indicators = data.indicators || [];

                    chart.data.labels = indicators.map(item => moment(item.date).format('MMM DD'));

                    // Price data
                    chart.data.datasets[0].data = indicators.map(item => item.price);
                    chart.data.datasets[0].label = `${data.symbol} Price`;

                    // SMA 20
                    chart.data.datasets[1].data = indicators.map(item => item.sma_20);

                    // SMA 50
                    chart.data.datasets[2].data = indicators.map(item => item.sma_50);

                    // Volume (scale down for visbility)
                    chart.data.datasets[3].data = indicators.map(item => item.price * 0.1);

                    chart.update('none');
                }

                updateMarketMetrics(data) {
                    const latest = data.data && data.data.length > 0 ? data.data[data.data.length - 1] : null;
                    const previous = data.data && data.data.length > 1 ? data.data[data.data.length - 2] : null;

                    document.getElementById('selectedSymbol').textContent = data.symbol;

                    if (latest) {
                        document.getElementById('currentPrice').textContent = `${latest.close.toFixed(2)}`;

                        if (previous) {
                            const change = ((latest.close - previous.close) / previous.close) * 100;
                            const changeElement = document.getElementById('dailyChange');
                            changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                            changeElement.className = `metric-value ${change >= 0 ? 'positive' : 'negative'}`; 
                        }
                    } else {
                        document.getElementById('currentPrice').textContent = '$-';
                        document.getElementById('dailyChange').textContent = '-%';
                    }
                }

                updateTechnicalIndicators(data) {
                    const container = document.getElementById('technicalIndicators');
                    const latest = data.indicators && data.indicators.length > 0 ?
                                data.indicators[data.indicators.length - 1] : null;
                    if (!latest) {
                        container.innerHTML = '<div class="text-center text-muted">No indicators available</div>';
                        document.getElementById('volatility').textContent = '-%';
                        document.getElementById('trend').textContent = '-';
                        return;
                    }

                    // Update volatility and trend in metrics
                    if (latest.volatility) {
                        document.getElementById('volatility').textContent = `${(latest.volatility * 100).toFixed(2)}%`;
                    }

                    if (latest.trend) {
                        const trendElement = document.getElementById('trend');
                        trendElement.textContent = latest.trend.replace('_', ' ').toUpperCase();
                        trendElement.className = `metric-value ${this.getTrendColor(latest.trend)}`;
                    }

                    // Build indicators Display
                    let indicatorsHtml = '';

                    if (latest.sma_20) { 
                        const above20 = latest.above_sma20;
                        indicatorsHtml += `
                            <div class = "d-flex justify-content-between align-items-center mb-2">
                                <span>20-Day SMA</span>
                                <span class="${above20 ? 'positive' : 'negative'}">
                                    ${latest.sma_20.toFixed(2)} ${above20 ? 'Up' : 'Down'}
                                </span>
                            </div>
                        `;
                    }

                    if (latest.sma_50) { 
                        const above50 = latest.above_sma50;
                        indicatorsHtml += `
                            <div class = "d-flex justify-content-between align-items-center mb-2">
                                <span>50-Day SMA</span>
                                <span class="${above50 ? 'positive' : 'negative'}">
                                    ${latest.sma_50.toFixed(2)} ${above50 ? 'Up' : 'Down'}
                                </span>
                            </div>
                        `;
                    }

                    if (latest.daily_return !== null) {
                        indicatorsHtml += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Daily Return</span>
                                <span class="${latest.daily_return >= 0 ? 'positive' : 'negative'}">
                                    ${(latest.daily_return * 100).toFixed(2)}%
                                </span>
                            </div>
                        `;
                    }

                    container.innerHTML = indicatorsHtml || '<div class="text-center text-muted">No indicators available</div>';
                }

                getTrendColor(trend) {
                    switch(trend) {
                        case 'strong_up': return 'postitive';
                        case 'up': return 'positive';
                        case 'strong_down': return 'negative';
                        case 'down': return 'negative';
                        default: return 'neutral';
                    }
                }

                changePeriod(days) {
                    this.currentDays = days;

                    // Update acctive button
                    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`show${days}Days`).classList.add('active');

                    if (this.currentSymbol) {
                        this.selectSymbol(this.currentSymbol);
                    }
                }

                async refreshAllData() {
                    if (this.isLoading) return;

                    this.isLoading = true;
                    const refreshBtn = document.getElementById('refreshBtn');
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    try {
                        // Refresh portfolio data
                        const portfolioResponse = await fetch(`/api/portfolio`);
                        if (portfolioResponse.ok) {
                            const portfolioData = await portfolioResponse.json();
                            this.updatePortfolioSummary(portfolioData);
                        }

                        // Refresh current symbol data
                        if (this.currentSymbol) {
                            await this.selectSymbol(this.currentSymbol)
                        }

                        this.showToast('success', 'Data refreshed successfully');
                    
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        this.showToast('error', 'Failed to refresh data');
                    } finally {
                        this.isLoading = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    }
                }

                updatePortfolioSummary(data) {
                    const summary = data.summary || {};

                    document.getElementById('totalSymbols').textContent = summary.total_symbols || 0;

                    const avgReturnElement = document.getElementById('avgReturn');
                    if (summary.avg_daily_return !== undefined) {
                        const returnPct = (summary.avg_daily_return * 100).toFixed(2);
                        avgReturnElement.textContent = `${returnPct}%`;
                        avgReturnElement.className = `metric-value ${summary.avg_daily_return >= 0 ? 'positive' : 'negative'}`;
                    }

                    document.getElementById('positiveStocks').textContent = summary.positive_stocks || 0;
                    document.getElementById('positiveRatio').textContent = `${summary.positive_ratio || 0}%`;

                    // Update top performers
                    if (data.top_performers && data.top_performers.length > 0) {
                        this.updateTopPerformers(data.top_performers.slice(0, 3));
                    }

                    // Update recent activity
                    if (data.recent_activity && data.recent_activity.length > 0) {
                        this.updateRecentActivity(data.recent_activity.slice(0, 3));
                    }
                }

                updateTopPerformers(performers) {
                    const container = document.getElementById('topPerformers');
                    let html = '';
                    
                    performers.forEach(stock => {
                        html += `
                        <div class="stock-item">
                            <div>
                                <div class="stock-symbol">${stock.symbol}</div>
                                <small>${stock.company_name.substring(0, 20)}...</small>
                            </div>
                            <div class="stock-change">+${stock.weekly_return.toFixed(2)}%</div>
                        </div>
                        `;
                    });

                    container.innerHTML = html;
                }

                updateRecentActivity(activities) {
                    const container = document.getElementById('recentActivity');
                    let html = '';

                    activities.forEach(stock => {
                        html += `
                            <div class="stock-item">
                                <div>
                                    <div class="stock-symbol">${stock.symbol}</div>
                                    <small>${stock.price.toFixed(2)}</small>
                                </div>
                                <div>${(stock.volume).toLocaleString()}</div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                }

                updateConnectionStatus(status, text) {
                    const indicators = document.getElementById('connectionStatus');
                    const textElement = document.getElementById('connectionText');

                    indicators.className = `status-indicator status-${status}`;
                    textElement.textContent = text;
                }

                showToast(type, message) {
                    const toastContainer = document.getElementById('toastContainer');
                    const toastId = 'toast-' + Date.now();

                    const toastHtml = `
                    <div class="toast" id="${toastId}" role="alert">
                            <div class="toast-header">
                                <i class="fas fa-${type === 'success' ? 'check-circle text-success' : 'exclamation-triangle text-warning'} me-2"></i>
                                <strong class="me-auto">Dashboard</strong>
                                <small class="text-muted">now</small>
                                <button type="button" class "btn-close" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">
                                ${message}
                            </div>
                        </div>
                    `;

                    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

                    const toast = new bootstrap.Toast(document.getElementById(toastId));
                    toast.show();

                    // Clean up after toast is hidden
                    setTimeout(() => {
                        const toastElement = document.getElementById(toastId);
                        if (toastElement) {
                            toastElement.remove();  // ← use the variable you just defined
                        }
                    }, 5000);
                }

                startAutoRefresh() {
                    // Refresh data every 5 minutes
                    this.refreshInterval = setInterval(() => {
                        this.refreshAllData();
                    }, 5 * 60 * 1000);
                }

                stopAutoRefresh() {
                    if (this.refreshInterval) {
                        clearInterval(this.refershInterval);
                        this.refreshInterval = null;
                    }
                }
             }

            // Initialize dashboard when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                window.StockDashboard = new StockDashboard();
            });

            // Handle page visibilit changes to pause/resume auto-refresh
            document.addEventListener('visbilitychange', function() {
                if (window.StockDashboard) {
                    if (document.hidden) {
                        window.StockDashboard.stopAutoRefresh();
                    } else {
                        window.StockDashboard.startAutoRefresh();
                        // Refresh data when page becomes visible again
                        setTimeout(() => {
                            window.StockDashboard.refreshAllData();
                        }, 1000);
                    }
                }
            });
         </script>
    </body>
</html>